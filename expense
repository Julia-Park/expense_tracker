#! /usr/bin/env ruby

require 'pg'
require 'yaml'

def display_help
  commands = YAML.load(File.read('./commands.yml'))
  puts "An expense recording system\n\nCommands:\n\n"

  length = commands.keys.max { |a, b| a.length <=> b.length }.length

  commands.each do |command, desc|
    puts "#{command.ljust(length)} : #{desc}"
  end
end

def list_expenses(db)
  expenses = db.exec('SELECT * FROM expenses;')

  expenses.each do |tuple|
    id = tuple['id'].rjust(3)
    amount = tuple['amount'].rjust(12)
    date = tuple['created_on'].rjust(10)
    memo = tuple['memo']

    puts "#{id} | #{date} | #{amount} | #{memo}"
  end
end

def add_expense(db, amount, memo)
  if amount.nil? || memo.nil?
    puts 'You must provide an amount and memo.'
    return
  elsif !amount.match?(/^\d{0,4}(\.\d{0,2})?$/)
    puts 'Enter a valid amount.'
    return
  end

  db.exec("INSERT INTO expenses (amount, memo) VALUES (#{amount}, '#{memo}');")
end

database = PG.connect(dbname: "expense_tracker")
commands = ARGV

case commands.first
when 'list' then list_expenses(database)
when 'add' then add_expense(database, commands[1], commands[2])
else display_help
end
